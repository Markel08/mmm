CREATE SCHEMA team_01; --Формируем рабочую область team_01

CREATE MATERIALIZED VIEW team_01.team_01_sales_daily as -- Формируем материализованное представление для ежедневной статистики
SELECT 
    DATE (order_purchase_ts) AS sale_date, -- Преобразуем временную метку в формат даты
    COUNT(DISTINCT o.order_id) AS orders_count,-- Подсчитываем количество уникальных заказов
    SUM(price) AS total_sales -- Вычисляем суммарную дневную выручку
FROM stg.orders o 
JOIN stg.order_items oi -- Объединяем информацию о заказах с товарными позициями
    ON o.order_id = oi.order_id
GROUP BY DATE(order_purchase_ts); -- Выполняем группировку по дням
REFRESH MATERIALIZED VIEW team_01.team_01_sales_daily;


CREATE MATERIALIZED VIEW team_01.team_01_product_sales as -- Создаем материализованное представление для товарной аналитики
SELECT 
    product_id,	-- Уникальный код товара
    COUNT(order_id) AS total_orders,  -- Совокупное количество заказов с данным товаром
    SUM(price) AS total_revenue -- Суммарный доход от продажи товара
FROM stg.order_items
GROUP BY product_id; -- Группируем данные по каждому товару
REFRESH MATERIALIZED VIEW team_01.team_01_product_sales;
 	
SELECT * -- DATA QUALITY CHECK 1: Контроль отсутствия пустых значений
FROM stg.orders
WHERE order_id IS NULL;


SELECT * --DATA QUALITY CHECK 2: Проверка ценового диапазона
FROM stg.order_items
WHERE price < 0;


SELECT order_id, COUNT(*) -- DATA QUALITY CHECK 3: Поиск повторяющихся записей
FROM stg.orders
GROUP BY order_id
HAVING COUNT(*) > 1;


CREATE TABLE team_01.data_quality_log (
    check_date TIMESTAMP,
    check_name TEXT,
    issue_count INT
);

COMMENT ON MATERIALIZED VIEW team_01.team_01_sales_daily -- Пояснение к витрине с помесячной динамикой
IS 'Витрина ежедневных продаж: метрики по количеству транзакций и обороту на основе данных stg.orders и stg.order_items';

COMMENT ON MATERIALIZED VIEW team_01.team_01_product_sales -- Пояснение к витрине товарной аналитики
IS 'Витрина продаж в разрезе товаров: частота покупок и доходность по каждой товарной позиции';
Отчет по контролю качества данных
1. Вводная часть

В рамках практического задания осуществлялась работа с информационной базой, восстановленной из резервной копии в среде DBeaver.
Проведен детальный анализ структуры таблиц, расположенных в следующих схемах:

raw — хранилище необработанных (исходных) данных

stg — слой промежуточного хранения (предварительно обработанные данные)

Ключевые таблицы, задействованные в анализе:

stg.orders — регистрационные данные о заказах (временные метки, статусы выполнения, идентификаторы покупателей)

stg.order_items — перечень товарных позиций в заказах (стоимость, идентификаторы продуктов)

На основе перечисленных таблиц формировались аналитические структуры в персональной схеме team_01.

2. Задачи верификации данных

До этапа построения витрин требовалось удостовериться в целостности и достоверности исходной информации, поскольку наличие искаженных данных способно привести к некорректным аналитическим выводам (например, ошибочной оценке оборота или активности покупателей).

В связи с этим был реализован ряд базовых процедур проверки качества:

контроль наличия пропусков (NULL)

верификация допустимых значений (стоимость)

выявление задвоенных записей

проверка корректности связей между таблицами

3. Результаты проверок
3.1 Контроль пропусков

Выполнена проверка критически важных полей на предмет отсутствия информации:

order_id

price

order_purchase_ts

Пример проверочного запроса:

SELECT COUNT(*)
FROM stg.orders
WHERE order_id IS NULL;

Вывод:
Существенных пропусков в идентификаторах и других значимых полях не зафиксировано.

Принятые меры:
При обнаружении пропусков такие записи подлежали бы исключению из аналитики для сохранения целостности соединений и агрегаций.

3.2 Контроль ценовых показателей

Учитывая, что стоимость товара не может выражаться отрицательным числом, выполнена проверка на наличие аномальных значений:

SELECT COUNT(*)
FROM stg.order_items
WHERE price < 0;

Вывод:
Отрицательные ценовые показатели отсутствуют (либо их количество минимально и не оказывает влияния).

Принятые меры:
При выявлении таких значений они подлежат фильтрации на этапе подготовки данных.

3.3 Контроль уникальности записей

Проведен анализ на наличие повторяющихся заказов по ключевому полю order_id:

SELECT order_id, COUNT()
FROM stg.orders
GROUP BY order_id
HAVING COUNT() > 1;

Вывод:
Повторяющиеся записи не обнаружены.

Принятые меры:
В витринах используется COUNT(DISTINCT order_id) для дополнительной защиты от потенциальных дубликатов.

3.4 Контроль связности данных

Поскольку построение витрин предполагает объединение таблиц orders и order_items, проверена полнота связей между ними.

SELECT COUNT(*)
FROM stg.order_items oi
LEFT JOIN stg.orders o
ON oi.order_id = o.order_id
WHERE o.order_id IS NULL;

Вывод:
Отсутствуют записи в order_items, не имеющие соответствия в orders.

Принятые меры:
Использование INNER JOIN в витринах гарантирует работу только с валидными данными.

4. Реализация витрин и обеспечение качества

В схеме team_01 созданы следующие витрины:

ежедневная статистика продаж (team_01_sales_daily)

товарная аналитика (team_01_product_sales)

При построении использовался слой stg как наиболее подготовленный для аналитической обработки.

Для минимизации влияния потенциальных проблем с качеством данных применены:

агрегация с учетом уникальности заказов (DISTINCT)

расчет сумм только по корректным ценовым значениям

объединение таблиц по первичному ключу order_id

использование правильного поля с датой (order_purchase_ts)

5. Обновление витрин

Учитывая возможность добавления новых данных, витрины реализованы через MATERIALIZED VIEW.
Актуализация выполняется с помощью команды:

REFRESH MATERIALIZED VIEW team_01.team_01_sales_daily;
REFRESH MATERIALIZED VIEW team_01.team_01_product_sales;

Данный подход обеспечивает пересчет витрин при поступлении свежих данных без необходимости пересоздания структур.

6. Обнаруженные сложности и способы их устранения

В ходе работы идентифицированы следующие потенциальные сложности:

неоднозначность при соединении таблиц (поле order_id присутствует в обеих)

расхождения в наименованиях атрибутов (например, order_purchase_ts против ожидаемого order_purchase_timestamp)

Способы решения:

применение полных алиасов таблиц (o.order_id, oi.price)

ориентация на фактические имена полей в stg-слое

предварительный контроль качества перед формированием витрин

7. Заключение

В процессе выполнения работы были:

проанализированы структуры таблиц raw и stg

сформированы собственные витрины в схеме team_01

организовано инкрементальное обновление через материализованные представления

реализован базовый контроль качества исходных данных

Проведенные проверки подтвердили, что данные в слое stg обладают достаточным качеством для аналитического использования.
Построенные витрины обеспечивают корректный и стабильный расчет ключевых показателей (оборот, активность покупателей, товарная статистика) и могут служить основой для последующего анализа.
